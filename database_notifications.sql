-- =============================================
-- TABELA DE NOTIFICA√á√ïES
-- =============================================

CREATE TABLE public.notificacoes (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  
  -- Quem recebe a notifica√ß√£o
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- Tipo da notifica√ß√£o
  tipo text NOT NULL CHECK (tipo IN ('venda', 'aniversario')),
  
  -- T√≠tulo curto (ex: "Nova venda registrada", "Anivers√°rio de Jo√£o")
  titulo text NOT NULL,
  
  -- Mensagem descritiva (ex: "Venda de R$ 143,00 para Jo√£o Silva", "Jo√£o Silva faz anivers√°rio hoje! üéÇ")
  mensagem text NOT NULL,
  
  -- Refer√™ncia opcional (ID da venda, ID do cliente, etc.)
  referencia_id text NULL,
  
  -- Status de leitura
  lida boolean NOT NULL DEFAULT false,
  
  -- Timestamps
  created_at timestamp with time zone NOT NULL DEFAULT now()
);

-- √çndices para performance
CREATE INDEX idx_notificacoes_user_id ON public.notificacoes(user_id);
CREATE INDEX idx_notificacoes_lida ON public.notificacoes(user_id, lida);
CREATE INDEX idx_notificacoes_created ON public.notificacoes(user_id, created_at DESC);

-- =============================================
-- RLS (ROW LEVEL SECURITY)
-- =============================================

-- Ativar RLS
ALTER TABLE public.notificacoes ENABLE ROW LEVEL SECURITY;

-- SELECT: Cada usu√°rio s√≥ v√™ SUAS notifica√ß√µes
CREATE POLICY "notificacoes_select_own"
ON public.notificacoes
FOR SELECT
TO authenticated
USING (user_id = auth.uid());

-- INSERT: O servidor pode criar notifica√ß√µes para qualquer usu√°rio
CREATE POLICY "notificacoes_insert_authenticated"
ON public.notificacoes
FOR INSERT
TO authenticated
WITH CHECK (true);

-- UPDATE: Cada usu√°rio s√≥ marca SUAS notifica√ß√µes como lidas
CREATE POLICY "notificacoes_update_own"
ON public.notificacoes
FOR UPDATE
TO authenticated
USING (user_id = auth.uid());

-- DELETE: Cada usu√°rio s√≥ deleta SUAS notifica√ß√µes
CREATE POLICY "notificacoes_delete_own"
ON public.notificacoes
FOR DELETE
TO authenticated
USING (user_id = auth.uid());

-- =============================================
-- TABELA CLIENTES (CRM)
-- =============================================

-- Adicionar coluna data_nascimento na tabela de clientes
ALTER TABLE public.crm_fermaquinas
ADD COLUMN IF NOT EXISTS data_nascimento date NULL;

-- =============================================
-- FUN√á√ÉO RPC PARA ANIVERSARIANTES
-- =============================================

-- Criar function no Supabase para buscar aniversariantes de hoje
CREATE OR REPLACE FUNCTION public.aniversariantes_hoje()
RETURNS SETOF crm_fermaquinas
LANGUAGE sql
SECURITY DEFINER
AS $$
  SELECT * FROM crm_fermaquinas
  WHERE data_nascimento IS NOT NULL
    AND deleted_at IS NULL
    AND EXTRACT(month FROM data_nascimento) = EXTRACT(month FROM CURRENT_DATE)
    AND EXTRACT(day FROM data_nascimento) = EXTRACT(day FROM CURRENT_DATE);
$$;
